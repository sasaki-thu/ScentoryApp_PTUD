@model IEnumerable<ScentoryApp.Models.DonHang>

@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="~/Adminassets/css/dataTables.bootstrap4.css">
<link rel="stylesheet" href="~/css/toast.css">

<style>
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .dataTables_filter {
        display: none;
    }

    #dataTable-1 thead th {
        color: #007bff;
    }

    .badge-status {
        min-width: 110px; /* Chỉnh rộng hơn chút để chữ không bị xuống dòng */
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row align-items-center mb-2">
                <div class="col">
                    <h2 class="h2 page-title">Quản lý đơn hàng</h2>
                </div>
                <div class="col-auto">
                    <div class="form-inline">
                        <div class="form-group mr-2">
                            <input type="text" id="customSearch" class="form-control" placeholder="🔍 Tìm đơn hàng..." style="min-width: 250px;">
                        </div>
                        <button type="button" class="btn btn-secondary mr-2" data-toggle="modal" data-target="#filterModal">
                            <i class="fe fe-filter fe-16"></i> Lọc đơn hàng
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                            <i class="fe fe-refresh-cw fe-16"></i> Làm mới
                        </button>
                    </div>
                </div>
            </div>

            <div class="row my-1">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-body">
                            <table class="table datatables" id="dataTable-1">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Khách hàng</th>
                                        <th>Thời gian đặt</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th>Giao dự kiến</th>
                                        <th>Tác vụ</th>
                                    </tr>
                                </thead>
                                <tbody id="orderTableBody">
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {
                                            <tr id="row-@item.IdDonHang.Trim()">
                                                <td><strong>@item.IdDonHang</strong></td>
                                                <td>
                                                    @item.IdKhachHangNavigation.HoTen <br />
                                                    <small class="text-muted">(@item.IdKhachHang)</small>
                                                </td>
                                                <td>@item.ThoiGianDatHang.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td class="text-primary font-weight-bold">
                                                    @item.TongTienDonHang.ToString("N0") ₫
                                                </td>
                                                <td>
                                                    @if (item.TinhTrangDonHang == "Đã giao")
                                                    {
                                                        <span class="badge badge-success badge-status">Đã giao</span>
                                                    }
                                                    else if (item.TinhTrangDonHang == "Đang giao")
                                                    {
                                                        <span class="badge badge-info badge-status text-white">Đang giao</span>
                                                    }
                                                    else if (item.TinhTrangDonHang == "Đã hủy")
                                                    {
                                                        <span class="badge badge-danger badge-status">Đã hủy</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-warning text-white badge-status">Đang chuẩn bị</span>
                                                    }
                                                </td>
                                                <td>@item.NgayGiaoHangDuKien.ToString("dd/MM/yyyy")</td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm dropdown-toggle more-vertical" type="button" data-toggle="dropdown">
                                                            <span class="text-muted sr-only">Action</span>
                                                        </button>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <a class="dropdown-item btn-details" href="javascript:void(0)" data-id="@item.IdDonHang.Trim()">Chi tiết/Sửa</a>
                                                            <div class="dropdown-divider"></div>
                                                            <a class="dropdown-item btn-delete text-danger" href="javascript:void(0)" data-id="@item.IdDonHang.Trim()">Xóa đơn</a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <fieldset id="orderFieldset">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Mã đơn hàng</label>
                                <input type="text" class="form-control" id="IdDonHang" name="IdDonHang" readonly style="font-weight:bold;">
                            </div>
                            <div class="form-group col-md-4">
                                <label>Khách hàng</label>
                                <input type="text" class="form-control" id="KhachHang" readonly>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Thời gian đặt hàng</label>
                                <input type="text" class="form-control" id="ThoiGianDatHang" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Tổng tiền</label>
                                <input type="text" class="form-control text-primary" id="TongTien" readonly style="font-weight:bold;">
                            </div>
                            <div class="form-group col-md-4">
                                <label>Phí vận chuyển</label>
                                <input type="text" class="form-control" id="PhiShip" readonly>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Mã giảm giá</label>
                                <input type="text" class="form-control" id="MaGiamGia" readonly>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-muted mb-3">Cập nhật trạng thái</h6>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Trạng thái đơn hàng</label>
                                <select class="form-control" id="TinhTrangDonHang" name="TinhTrangDonHang">
                                    <option value="Đang chuẩn bị hàng">Đang chuẩn bị hàng</option>
                                    <option value="Đang giao">Đang giao</option>
                                    <option value="Đã giao">Đã giao (Hoàn tất)</option>
                                    <option value="Đã hủy">Đã hủy</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Ngày giao dự kiến</label>
                                <input type="date" class="form-control" id="NgayGiaoHangDuKien" name="NgayGiaoHangDuKien">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Địa chỉ giao hàng (Readonly)</label>
                            <textarea class="form-control" id="DiaChiGiao" rows="2" readonly></textarea>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button class="btn btn-primary" id="btnSave">Cập nhật trạng thái</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-slide" id="filterModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bộ lọc đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="p-2">
                    <div class="form-group my-3">
                        <label class="font-weight-bold">Khách hàng / Mã KH</label>
                        <input type="text" id="filterName" class="form-control" placeholder="Nhập tên hoặc ID...">
                    </div>

                    <div class="form-group my-3">
                        <label class="font-weight-bold">Trạng thái đơn hàng</label>
                        <select class="form-control" id="filterStatus">
                            <option value="">-- Tất cả --</option>
                            <option value="Đang chuẩn bị hàng">Đang chuẩn bị hàng</option>
                            <option value="Đang giao">Đang giao</option>
                            <option value="Đã giao">Đã giao</option>
                            <option value="Đã hủy">Đã hủy</option>
                        </select>
                    </div>

                    <div class="form-group my-3">
                        <label class="font-weight-bold">Ngày đặt hàng</label>
                        <div class="row">
                            <div class="col-6">
                                <small>Từ ngày:</small>
                                <input type="date" id="minDate" class="form-control">
                            </div>
                            <div class="col-6">
                                <small>Đến ngày:</small>
                                <input type="date" id="maxDate" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" id="btnApplyFilter">Áp dụng</button>
                <button type="button" class="btn btn-secondary btn-block" id="btnResetFilter">Đặt lại</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa đơn</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa đơn hàng <strong id="deleteName"></strong> không? <br />
                <small class="text-danger">Lưu ý: Chỉ nên xóa đơn Đã hủy hoặc đơn rác.</small>
                <input type="hidden" id="deleteId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Xóa vĩnh viễn</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/toast.js"></script>
    <script src="~/Adminassets/js/jquery.dataTables.min.js"></script>
    <script src="~/Adminassets/js/dataTables.bootstrap4.min.js"></script>

    <script>
        $(document).ready(function () {

            // 1. DATATABLES
            var table = $('#dataTable-1').DataTable({
                autoWidth: true,
                "lengthChange": false,
                "searching": true,
                "dom": 'rt<"row mt-3"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6 text-md-right"p>>',
                "language": {
                    "sProcessing":   "Đang xử lý...",
                    "sZeroRecords":  "Không tìm thấy đơn hàng nào",
                    "sInfo":         "Đang hiển thị _START_ đến _END_ trong _TOTAL_ đơn",
                    "sInfoEmpty":    "Đang hiển thị 0 đến 0 trong 0 đơn",
                    "sInfoFiltered": "(lọc từ _MAX_ đơn)",
                    "sSearch":       "Tìm kiếm:",
                    "oPaginate": { "sFirst": "Đầu", "sPrevious": "Trước", "sNext": "Tiếp", "sLast": "Cuối" }
                }
            });

            // LOGIC LỌC ĐƠN HÀNG
            function parseDateVN(dateString) {
                if (!dateString) return null;
                var parts = dateString.split(' ')[0].split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return null;
            }

            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    var filterName = $('#filterName').val().toLowerCase();
                    var filterStatus = $('#filterStatus').val();
                    var minDateVal = $('#minDate').val();
                    var maxDateVal = $('#maxDate').val();

                    var customerText = $(table.row(dataIndex).node()).find('td:eq(1)').text().toLowerCase().trim();
                    var orderDateRaw = data[2];
                    var statusText = $(table.row(dataIndex).node()).find('td:eq(4)').text().trim();

                    if (filterName && !customerText.includes(filterName)) return false;

                    // So sánh trạng thái
                    if (filterStatus) {
                        // Vì "Đang chuẩn bị hàng" ở badge hiển thị là "Đang chuẩn bị"
                        if (filterStatus === "Đang chuẩn bị hàng" && !statusText.includes("Đang chuẩn bị")) return false;
                        else if (filterStatus !== "Đang chuẩn bị hàng" && statusText !== filterStatus) return false;
                    }

                    var orderDate = parseDateVN(orderDateRaw);
                    if (minDateVal) {
                        var minDate = new Date(minDateVal);
                        if (orderDate < minDate) return false;
                    }
                    if (maxDateVal) {
                        var maxDate = new Date(maxDateVal);
                        if (orderDate > maxDate) return false;
                    }
                    return true;
                }
            );

            $('#btnApplyFilter').click(function() {
                table.draw();
                $('#filterModal').modal('hide');
            });

            $('#btnResetFilter').click(function() {
                $('#filterName').val('');
                $('#filterStatus').val('');
                $('#minDate').val('');
                $('#maxDate').val('');
                table.draw();
            });

            $('#customSearch').on('keyup', function () { table.search(this.value).draw(); });

            // 2. XEM CHI TIẾT / SỬA
            $('body').on('click', '.btn-details', function (e) {
                e.preventDefault();
                var id = $(this).data('id');

                $.ajax({
                    url: '/Admin/AdminOrders/GetById',
                    type: 'GET',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            var d = res.data;

                            $('#IdDonHang').val(d.idDonHang);
                            $('#KhachHang').val(d.khachHang);
                            $('#ThoiGianDatHang').val(d.thoiGianDatHang);

                            $('#TongTien').val(new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(d.tongTien));
                            $('#PhiShip').val(new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(d.phiShip));

                            $('#MaGiamGia').val(d.maGiamGia);
                            $('#DiaChiGiao').val(d.diaChiGiao);

                            $('#TinhTrangDonHang').val(d.trangThai);
                            $('#NgayGiaoHangDuKien').val(d.ngayGiaoHangDuKien);

                            $('#orderModal').modal('show');
                        } else {
                            showToast(res.message, 'error');
                        }
                    },
                    error: function() { showToast("Lỗi kết nối!", 'error'); }
                });
            });

            // 3. CẬP NHẬT (UPDATE)
            $('#btnSave').click(function () {
                var id = $('#IdDonHang').val();
                var status = $('#TinhTrangDonHang').val();
                var date = $('#NgayGiaoHangDuKien').val();

                $.ajax({
                    url: '/Admin/AdminOrders/Update',
                    type: 'POST',
                    data: {
                        IdDonHang: id,
                        TinhTrangDonHang: status,
                        NgayGiaoHangDuKien: date
                    },
                    success: function (res) {
                        if (res.success) {
                            showToast(res.message, 'success');
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            showToast("Lỗi: " + res.message, 'error');
                        }
                    },
                    error: function () { showToast("Lỗi hệ thống!", 'error'); }
                });
            });

            // 4. XÓA (DELETE)
            $('body').on('click', '.btn-delete', function () {
                var id = $(this).data('id');
                $('#deleteName').text(id);
                $('#deleteId').val(id);
                $('#deleteModal').modal('show');
            });

            $('#btnConfirmDelete').click(function () {
                var id = $('#deleteId').val();
                $.ajax({
                    url: '/Admin/AdminOrders/Delete',
                    type: 'POST',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            $('#deleteModal').modal('hide');
                            showToast(res.message, 'success');
                            var t = $('#dataTable-1').DataTable();
                            t.row($('#row-' + id)).remove().draw();
                        } else {
                            showToast(res.message, 'error');
                        }
                    },
                    error: function() { showToast("Lỗi khi xóa đơn hàng.", 'error'); }
                });
            });
        });
    </script>
}