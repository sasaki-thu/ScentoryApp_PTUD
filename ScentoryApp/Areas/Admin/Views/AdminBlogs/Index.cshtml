@model IEnumerable<ScentoryApp.Models.Blog>

@{
    ViewData["Title"] = "Quản lý Blog";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<!-- CSS -->
<link rel="stylesheet" href="~/Adminassets/css/dataTables.bootstrap4.css">
<link rel="stylesheet" href="~/Adminassets/css/quill.snow.css">
<style>
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .dataTables_filter {
        display: none;
    }

    #dataTable-1 thead th {
        color: #007bff;
    }

    /* CSS cho vùng upload ảnh */
    .image-upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background: #fff;
    }

        .image-upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

    #imagePreview img {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 4px;
    }

    /* CSS cho Tabs trong Modal */
    .nav-tabs .nav-link {
        cursor: pointer;
    }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #007bff;
        }

    .tab-content {
        padding-top: 20px;
    }

    /* CSS cho QL editor */
    .ql-editor {
        min-height: 300px;
        background-color: white;
    }

    /* Chỉnh màu chữ thông báo lỗi thành màu đỏ */
    label.error {
        color: red;
        font-size: 13px;
        display: block;
        margin-top: 5px;
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Header -->
            <div class="row align-items-center mb-2">
                <div class="col">
                    <h2 class="h2 page-title">Quản lý bài viết (Blog)</h2>
                </div>
                <div class="col-auto">
                    <div class="form-inline">
                        <div class="form-group mr-2">
                            <input type="text" id="customSearch" class="form-control" placeholder="🔍 Tìm kiếm bài viết..." style="min-width: 250px;">
                        </div>
                        <button type="button" class="btn btn-primary" id="addBlogBtn">
                            <i class="fe fe-plus fe-16"></i> Thêm bài viết
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bảng dữ liệu -->
            <div class="row my-1">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-body">
                            <table class="table datatables" id="dataTable-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tiêu đề Blog</th>
                                        <th>Danh mục</th>
                                        <th>Trạng thái</th>
                                        <th>Lượt xem</th>
                                        <th>Ngày tạo</th>
                                        <th>Tác vụ</th>
                                    </tr>
                                </thead>
                                <tbody id="blogTableBody">
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {
                                            <tr id="row-@item.IdBlog.Trim()">
                                                <td>@item.IdBlog</td>
                                                <td>
                                                    @if (item.TenBlog.Length > 50)
                                                    {
                                                        @item.TenBlog.Substring(0, 50)
                                                        <span>...</span>
                                                    }
                                                    else
                                                    {
                                                        @item.TenBlog
                                                    }
                                                </td>
                                                <td>@item.DanhMucBlog</td>
                                                <td>
                                                    @if (item.TrangThai == 1)
                                                    {
                                                        <span class="badge badge-success">Đã đăng</span>
                                                    }
                                                    else
                                                    {

                                                        <span class="badge badge-secondary">Nháp/Ẩn</span>
                                                    }
                                                </td>
                                                <td>@item.Views</td>
                                                <td>@item.ThoiGianTaoBlog.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm dropdown-toggle more-vertical" type="button" data-toggle="dropdown">
                                                            <span class="text-muted sr-only">Action</span>
                                                        </button>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <a class="dropdown-item btn-details" href="javascript:void(0)" data-id="@item.IdBlog.Trim()">Chi tiết</a>
                                                            <a class="dropdown-item btn-edit" href="javascript:void(0)" data-id="@item.IdBlog.Trim()">Chỉnh sửa</a>
                                                            <a class="dropdown-item btn-delete" href="javascript:void(0)" data-id="@item.IdBlog.Trim()">Xóa</a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Form Nhập Liệu (3 TAB) -->
<div class="modal fade" id="blogModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <!-- Modal XL cho rộng rãi -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thông tin bài viết</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="blogForm">
                    <!-- NAV TABS -->
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="true">THÔNG TIN TIN TỨC</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="desc-tab" data-toggle="tab" href="#desc" role="tab" aria-controls="desc" aria-selected="false">MÔ TẢ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="seo-tab" data-toggle="tab" href="#seo" role="tab" aria-controls="seo" aria-selected="false">THÔNG TIN SEO</a>
                        </li>
                    </ul>

                    <!-- TAB CONTENT -->
                    <div class="tab-content" id="myTabContent">

                        <!-- TAB 1: THÔNG TIN CHUNG -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label>ID Blog</label>
                                    <input type="text" class="form-control" id="IdBlog" name="IdBlog" placeholder="BL00x" required>
                                </div>
                                <div class="form-group col-md-8">
                                    <label>Tiêu đề</label>
                                    <input type="text" class="form-control" id="TenBlog" name="TenBlog" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Danh mục</label>
                                    <select class="form-control" id="DanhMucBlog" name="DanhMucBlog" required>
                                        <option value="">-- Chọn danh mục --</option>
                                        <option value="Thương hiệu">Thương hiệu</option>
                                        <option value="Sản phẩm">Sản phẩm</option>
                                        <option value="HDSD">HDSD</option>
                                        <option value="Kiến thức">Kiến thức</option>
                                        <option value="Mẹo">Mẹo</option>
                                        <option value="Storytelling">Storytelling</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Tags</label>
                                    <input type="text" class="form-control" id="Tag" name="Tag" placeholder="vd: nuoc-hoa, thom-lau..." required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Ảnh Blog</label>
                                <div id="imageDropzone" class="image-upload-area p-4 text-center">
                                    <input type="file" id="ImageFile" name="ImageFile" accept="image/*" class="d-none">
                                    <i class="fe fe-upload fe-24 text-muted"></i>
                                    <p class="mt-2 text-muted">Nhấp để chọn ảnh</p>
                                </div>
                                <div id="imagePreview" class="mt-2 text-center" style="display:none;">
                                    <img id="previewImg" src="" alt="Preview">
                                    <br />
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageBtn">Xóa ảnh</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Trạng thái</label>
                                <div class="custom-control custom-switch" required>
                                    <!-- Value 1 = Published, 0 = Draft -->
                                    <input type="checkbox" class="custom-control-input" id="TrangThaiSwitch" checked>
                                    <label class="custom-control-label" for="TrangThaiSwitch">Đăng ngay (Published)</label>
                                    <input type="hidden" id="TrangThai" name="TrangThai" value="1">
                                </div>
                            </div>

                            <!-- Thông tin ngày tháng (Readonly) -->
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Thời gian tạo</label>
                                    <input type="text" class="form-control" id="ThoiGianTaoBlog" readonly placeholder="Tự động cập nhật...">
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Cập nhật lần cuối</label>
                                    <input type="text" class="form-control" id="ThoiGianCapNhatBlog" readonly placeholder="Chưa cập nhật">
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: MÔ TẢ (NỘI DUNG) -->
                        <div class="tab-pane fade" id="desc" role="tabpanel" aria-labelledby="desc-tab">
                            <div class="form-group">
                                <label>Nội dung ngắn</label>
                                <textarea class="form-control" id="NoiDungNgan" name="NoiDungNgan" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Nội dung chi tiết</label>
                                <div id="quillEditor" style="min-height: 200px;"></div>

                                <input type="hidden" id="NoiDung" name="NoiDung">
                            </div>
                        </div>

                        <!-- TAB 3: SEO -->
                        <div class="tab-pane fade" id="seo" role="tabpanel" aria-labelledby="seo-tab">
                            <div class="form-group">
                                <label>Meta Keywords</label>
                                <input type="text" class="form-control" id="MetaKey" name="MetaKey" placeholder="Từ khóa SEO...">
                            </div>
                            <div class="form-group">
                                <label>Meta Description</label>
                                <textarea class="form-control" id="MetaDesc" name="MetaDesc" rows="3" placeholder="Mô tả SEO..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Alias (URL thân thiện)</label>
                                <input type="text" class="form-control" id="Alias" name="Alias" placeholder="tu-dong-tao-tu-tieu-de">
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnSave">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa bài viết <strong id="deleteName"></strong>?
                <input type="hidden" id="deleteId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Adminassets/js/quill.min.js"></script>
    <script src="~/Adminassets/js/jquery.dataTables.min.js"></script>
    <script src="~/Adminassets/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/Adminassets/js/jquery.validate.min.js"></script>

    <script>
        var quill;

        $(document).ready(function () {

            // --- 1. KHỞI TẠO QUILL ---
            if ($("#quillEditor").length) {
                var toolbarOptions = [
                  [{ 'header': [1, 2, 3, false] }],
                  ['bold', 'italic', 'underline', 'strike'],
                  ['blockquote', 'code-block'],
                  [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                  [{ 'align': [] }],
                  ['link', 'image'],
                  ['clean']
                ];

                quill = new Quill('#quillEditor', {
                    modules: { toolbar: toolbarOptions },
                    theme: 'snow'
                });

                // [QUAN TRỌNG] Đồng bộ dữ liệu từ Quill sang Input ẩn khi gõ
                quill.on('text-change', function() {
                    var html = quill.root.innerHTML;
                    // Quill mặc định có thẻ <p><br></p> khi trống, cần xóa đi để validate hoạt động đúng
                    if (html === '<p><br></p>') html = '';
                    $('#NoiDung').val(html);

                    // Kích hoạt validate lại ô này để xóa lỗi nếu đã nhập
                    $('#NoiDung').valid();
                });
            }

            // --- 2. CẤU HÌNH VALIDATE ---
            $("#blogForm").validate({
                ignore: [], // QUAN TRỌNG: Cho phép validate input ẩn (#NoiDung)
                rules: {
                    IdBlog: { required: true, minlength: 5, maxlength: 5 },
                    TenBlog: { required: true },
                    DanhMucBlog: { required: true },
                    Tag: { required: true },
                    NoiDungNgan: { required: true },
                    NoiDung: { required: true } // Validate ô input ẩn này
                },
                messages: {
                    IdBlog: {
                        required: "Vui lòng nhập ID Blog",
                        minlength: "ID phải có 5 ký tự",
                        maxlength: "ID phải có 5 ký tự"
                    },
                    TenBlog: "Tiêu đề không được để trống",
                    Tag: "Tags không được để trống",
                    DanhMucBlog: "Hãy chọn một danh mục",
                    NoiDungNgan: "Mô tả ngắn không được để trống",
                    NoiDung: "Nội dung bài viết không được để trống"
                },
                errorPlacement: function(error, element) {
                    // Chỉnh vị trí hiện lỗi cho đẹp
                    if (element.attr("name") == "NoiDung") {
                        // Với Quill, hiện lỗi bên dưới khung soạn thảo
                        error.insertAfter("#quillEditor");
                    } else {
                        error.insertAfter(element);
                    }
                }
            });

            // --- 3. DATATABLES ---
            var table = $('#dataTable-1').DataTable({
                "lengthChange": false,
                "searching": true,
                "dom": 'rt<"row mt-3"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6 text-md-right"p>>',
                "language": { "sProcessing": "Đang xử lý...", "sZeroRecords": "Không tìm thấy bài viết", "sInfo": "Hiển thị _START_ đến _END_ trong _TOTAL_ bài", "sSearch": "Tìm kiếm:", "oPaginate": { "sNext": "Tiếp", "sPrevious": "Trước" } }
            });
            $('#customSearch').on('keyup', function () { table.search(this.value).draw(); });

            // --- 4. LOGIC ẢNH ---
                    $('#imageDropzone').off('click').on('click', function (e) {
            e.stopPropagation();

            if (!$('#productFieldset').prop('disabled')) {
                $('#ImageFile')[0].click();
            }
        });

        $('#ImageFile').off('change').on('change', function () {
            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#previewImg').attr('src', e.target.result);
                    $('#imagePreview').css('display', 'flex');
                    $('#imageDropzone').hide();
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // remove image
        $('#removeImageBtn').off('click').on('click', function () {
            $('#ImageFile').val('');
            $('#previewImg').attr('src', '');
            $('#imagePreview').hide();
            $('#imageDropzone').show();
        });

            // --- 5. RESET FORM ---
            function resetForm() {
                var validator = $("#blogForm").validate();
                validator.resetForm(); // Xóa thông báo lỗi cũ
                $('.error').removeClass('error'); // Xóa class lỗi

                $('#blogForm')[0].reset();
                $('#IdBlog').prop('readonly', false);
                $('#removeImageBtn').click();
                $('#myTab a[href="#info"]').tab('show');
                $('#TrangThaiSwitch').prop('checked', true); $('#TrangThai').val('1');
                $('#ThoiGianTaoBlog').val(''); 
                $('#ThoiGianCapNhatBlog').val('');

                $('#blogForm input, #blogForm textarea, #blogForm select').prop('disabled', false);
                $('#btnSave').show();

                // Reset Quill
                if(quill) {
                    quill.root.innerHTML = '';
                    quill.enable(true);
                    $('#NoiDung').val(''); 
                }
            }

            // --- CÁC NÚT BẤM ---
            $('#addBlogBtn').click(function () {
                resetForm();
                $('#modalTitle').text('Thêm bài viết mới');
                var now = new Date().toLocaleString();
                $('#ThoiGianTaoBlog').val(now);
                $('#blogModal').modal('show');
            });

            $('body').on('click', '.btn-edit, .btn-details', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                var isDetail = $(this).hasClass('btn-details');
                // Reset form để xóa lỗi cũ trước khi load data mới
                var validator = $("#blogForm").validate();
                validator.resetForm();
                $('.error').removeClass('error');

                $.ajax({
                    url: '/Admin/AdminBlogs/GetById',
                    type: 'GET',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            var d = res.data;
                            $('#IdBlog').val(d.idBlog).prop('readonly', true);
                            $('#TenBlog').val(d.tenBlog);
                            $('#DanhMucBlog').val(d.danhMucBlog);
                            $('#Tag').val(d.tag);
                            $('#Alias').val(d.alias);
                            $('#MetaKey').val(d.metaKey);
                            $('#MetaDesc').val(d.metaDesc);
                            $('#NoiDungNgan').val(d.noiDungNgan);

                            if (d.anhBase64) {
                                $('#previewImg').attr('src', d.anhBase64);
                                $('#imagePreview').show(); $('#imageDropzone').hide();
                            } else {
                                $('#removeImageBtn').click();
                            }

                            if(d.trangThai == 1) { $('#TrangThaiSwitch').prop('checked', true); $('#TrangThai').val('1'); }
                            else { $('#TrangThaiSwitch').prop('checked', false); $('#TrangThai').val('0'); }

                            $('#ThoiGianTaoBlog').val(d.thoiGianTaoBlog);
                            $('#ThoiGianCapNhatBlog').val(d.thoiGianCapNhatBlog);

                            // Map Quill
                            if (quill) {
                                quill.root.innerHTML = d.noiDung || '';
                                $('#NoiDung').val(d.noiDung); // Cập nhật luôn input ẩn
                            }

                            if (isDetail) {
                                $('#modalTitle').text('Chi tiết bài viết');
                                $('#blogForm input, #blogForm textarea, #blogForm select').prop('disabled', true);
                                if(quill) quill.enable(false);
                                $('#btnSave').hide(); $('#removeImageBtn').hide();
                            } else {
                                $('#modalTitle').text('Cập nhật bài viết');
                                $('#blogForm input, #blogForm textarea, #blogForm select').prop('disabled', false);
                                if(quill) quill.enable(true);
                                $('#btnSave').show();
                                $('#removeImageBtn').show();
                            }
                            $('#blogModal').modal('show');
                        }
                    }
                });
            });

            // --- 6. NÚT LƯU (CÓ VALIDATE) ---
            $('#btnSave').click(function () {
                if(quill) {
                    var html = quill.root.innerHTML;
                    if (html === '<p><br></p>') html = '';
                    $('#NoiDung').val(html);
                }

                // Kiểm tra Validate
                if ($("#blogForm").valid()) {
                    var formData = new FormData($('#blogForm')[0]);

                    $.ajax({
                        url: '/Admin/AdminBlogs/Save',
                        type: 'POST',
                        data: formData,
                        contentType: false, processData: false,
                        success: function (res) {
                            if (res.success) {
                                alert(res.message);
                                location.reload();
                            } else {
                                alert("Lỗi: " + res.message);
                            }
                        },
                        error: function () { alert("Lỗi hệ thống!"); }
                    });
                } else {
                    // Nếu form lỗi, focus vào tab đầu tiên có lỗi
                    var firstError = $("#blogForm").validate().errorList[0].element;
                    var tabId = $(firstError).closest('.tab-pane').attr('id');
                    if(tabId) {
                        $('.nav-tabs a[href="#' + tabId + '"]').tab('show');
                    }
                }
            });

            // Xóa
            $('body').on('click', '.btn-delete', function () {
                $('#deleteId').val($(this).data('id'));
                $('#deleteModal').modal('show');
            });
            $('#btnConfirmDelete').click(function () {
                $.ajax({
                    url: '/Admin/AdminBlogs/Delete',
                    type: 'POST',
                    data: { id: $('#deleteId').val() },
                    success: function(res){ if(res.success) location.reload(); }
                });
            });
            $('#TrangThaiSwitch').change(function() { $('#TrangThai').val(this.checked ? '1' : '0'); });
        });
    </script>
}