@model IEnumerable<ScentoryApp.Models.KhachHang>

@{
    ViewData["Title"] = "Quản lý khách hàng";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="~/Adminassets/css/dataTables.bootstrap4.css">
<link rel="stylesheet" href="~/css/toast.css">

<style>
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .dataTables_filter {
        display: none;
    }

    #dataTable-1 thead th {
        color: #007bff;
    }

    /* CSS cho Validation (Chữ đỏ) */
    label.error {
        color: #dc3545;
        font-size: 13px;
        display: block;
        margin-top: 5px;
        font-weight: normal;
    }

    input.error, select.error, textarea.error {
        border-color: #dc3545;
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row align-items-center mb-2">
                <div class="col">
                    <h2 class="h2 page-title">Quản lý khách hàng</h2>
                </div>
                <div class="col-auto">
                    <div class="form-inline">
                        <div class="form-group mr-2">
                            <input type="text" id="customSearch" class="form-control" placeholder="🔍 Tìm kiếm..." style="min-width: 250px;">
                        </div>
                        <button type="button" class="btn btn-primary" id="addUserBtn">
                            <i class="fe fe-plus fe-16"></i> Thêm khách hàng
                        </button>
                    </div>
                </div>
            </div>

            <div class="row my-1">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-body">
                            <table class="table datatables" id="dataTable-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Họ tên</th>
                                        <th>Email</th>
                                        <th>Số điện thoại</th>
                                        <th>Giới tính</th>
                                        <th>Ngày sinh</th>
                                        <th>Tài khoản</th>
                                        <th>Tác vụ</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {
                                            <tr id="row-@item.IdKhachHang.Trim()">
                                                <td>@item.IdKhachHang</td>
                                                <td>@item.HoTen</td>
                                                <td>@item.Email</td>
                                                <td>@item.Sdt</td>
                                                <td>
                                                    @if (item.GioiTinh == "Nam")
                                                    {
                                                        <span class="badge badge-info">Nam</span>
                                                    }
                                                    else if (item.GioiTinh == "Nữ")
                                                    {

                                                        <span class="badge badge-warning text-white">Nữ</span>
                                                    }
                                                </td>
                                                <td>@item.NgaySinh.ToString("dd/MM/yyyy")</td>
                                                <td>
                                                    @if (item.IdTaiKhoanNavigation != null)
                                                    {
                                                        <span>@item.IdTaiKhoanNavigation.TenDangNhap</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted font-italic">Chưa liên kết</span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm dropdown-toggle more-vertical" type="button" data-toggle="dropdown"></button>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <a class="dropdown-item btn-details" href="javascript:void(0)" data-id="@item.IdKhachHang.Trim()">Chi tiết</a>
                                                            <a class="dropdown-item btn-edit" href="javascript:void(0)" data-id="@item.IdKhachHang.Trim()">Chỉnh sửa</a>
                                                            <a class="dropdown-item btn-delete" href="javascript:void(0)" data-id="@item.IdKhachHang.Trim()">Xóa</a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thông tin khách hàng</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <fieldset id="userFieldset">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>ID Khách hàng (*)</label>
                                <input type="text" class="form-control" id="IdKhachHang" name="IdKhachHang"
                                       readonly style="background-color: #e9ecef; font-weight: bold;">
                            </div>
                            <div class="form-group col-md-8">
                                <label>Họ và Tên (*)</label>
                                <input type="text" class="form-control" id="HoTen" name="HoTen">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Email (*)</label>
                                <input type="email" class="form-control" id="Email" name="Email">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Số điện thoại (*)</label>
                                <input type="text" class="form-control" id="Sdt" name="Sdt">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Giới tính (*)</label>
                                <select class="form-control" id="GioiTinh" name="GioiTinh">
                                    <option value="">-- Chọn giới tính --</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Ngày sinh (*)</label>
                                <input type="date" class="form-control" id="NgaySinh" name="NgaySinh">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Tài khoản liên kết</label>
                            <select class="form-control" id="IdTaiKhoan" name="IdTaiKhoan" asp-items="ViewBag.ListTaiKhoan">
                                <option value="">-- Chưa liên kết tài khoản --</option>
                            </select>
                            <small class="form-text text-muted">Chọn tài khoản đăng nhập cho khách hàng này (nếu có).</small>
                        </div>

                        <div class="form-group">
                            <label>Địa chỉ (*)</label>
                            <textarea class="form-control" id="DiaChi" name="DiaChi" rows="2"></textarea>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnSave">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa khách hàng <strong id="deleteName"></strong> không?
                <input type="hidden" id="deleteId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

@section Scripts {
    <script src="~/js/toast.js"></script>
    <script src="~/Adminassets/js/jquery.dataTables.min.js"></script>
    <script src="~/Adminassets/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/Adminassets/js/jquery.validate.min.js"></script>

    <script>
        $(document).ready(function () {

            // --- 4. CẤU HÌNH VALIDATE ---
            $("#userForm").validate({
                rules: {
                    IdKhachHang: { required: true, minlength: 5, maxlength: 5 },
                    HoTen: { required: true },
                    Email: { required: true, email: true },
                    Sdt: { required: true, number: true, minlength: 10, maxlength: 10 },
                    GioiTinh: { required: true },
                    NgaySinh: { required: true },
                    DiaChi: { required: true }
                },
                messages: {
                    IdKhachHang: {
                        required: "Vui lòng nhập ID",
                        minlength: "ID phải đúng 5 ký tự",
                        maxlength: "ID phải đúng 5 ký tự"
                    },
                    HoTen: "Vui lòng nhập họ tên",
                    Email: {
                        required: "Vui lòng nhập email",
                        email: "Email không đúng định dạng"
                    },
                    Sdt: {
                        required: "Vui lòng nhập số điện thoại",
                        number: "SĐT phải là số",
                        minlength: "SĐT phải đủ 10 số",
                        maxlength: "SĐT tối đa 10 số"
                    },
                    GioiTinh: "Vui lòng chọn giới tính",
                    NgaySinh: "Vui lòng chọn ngày sinh",
                    DiaChi: "Vui lòng nhập địa chỉ"
                }
            });

            // --- 5. DATATABLES ---
            var table = $('#dataTable-1').DataTable({
                "lengthChange": false,
                "searching": true,
                "dom": 'rt<"row mt-3"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6 text-md-right"p>>',
                "language": { "sProcessing": "Đang xử lý...", "sZeroRecords": "Không tìm thấy khách hàng", "sInfo": "Hiển thị _START_ đến _END_ trong _TOTAL_ khách", "sSearch": "Tìm kiếm:", "oPaginate": { "sNext": "Tiếp", "sPrevious": "Trước" } }
            });
            $('#customSearch').on('keyup', function () { table.search(this.value).draw(); });

            // --- 6. RESET FORM ---
            function resetForm() {
                var validator = $("#userForm").validate();
                validator.resetForm();
                $('.error').removeClass('error');
                $('#userForm')[0].reset();
                $('#userFieldset').prop('disabled', false);
                $('#btnSave').show();
            }

            // --- CÁC NÚT BẤM ---
        $('#addUserBtn').click(function () {
            resetForm();
            $('#modalTitle').text('Thêm khách hàng mới');

            $.get('/Admin/AdminUsers/GetNextId', function(res) {
                if(res.success) {
                    $('#IdKhachHang').val(res.data).prop('readonly', true);
                } else {
                    showToast("Lỗi lấy mã khách hàng", "error");
                }
            });

            $('#userModal').modal('show');
        });

            // Sửa / Chi tiết
            $('body').on('click', '.btn-edit, .btn-details', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                var isDetail = $(this).hasClass('btn-details');

                // Reset trước khi load
                var validator = $("#userForm").validate();
                validator.resetForm();
                $('.error').removeClass('error');

                $.ajax({
                    url: '/Admin/AdminUsers/GetById',
                    type: 'GET',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            var d = res.data;
                            $('#IdKhachHang').val(d.idKhachHang).prop('readonly', true);
                            $('#HoTen').val(d.hoTen);
                            $('#Email').val(d.email);
                            $('#Sdt').val(d.sdt);
                            $('#GioiTinh').val(d.gioiTinh);
                            $('#NgaySinh').val(d.ngaySinh);
                            $('#DiaChi').val(d.diaChi);
                            $('#IdTaiKhoan').val(d.idTaiKhoan);

                            if (isDetail) {
                                $('#modalTitle').text('Chi tiết khách hàng');
                                $('#userFieldset').prop('disabled', true);
                                $('#btnSave').hide();
                            } else {
                                $('#modalTitle').text('Cập nhật khách hàng');
                                $('#userFieldset').prop('disabled', false);
                                $('#btnSave').show();
                            }
                            $('#userModal').modal('show');
                        } else {
                            showToast(res.message, 'error');
                        }
                    },
                    error: function() { showToast("Lỗi kết nối!", 'error'); }
                });
            });

            // --- 7. NÚT LƯU ---
            $('#btnSave').click(function () {
                if ($("#userForm").valid()) {
                    var formData = new FormData($('#userForm')[0]);

                    $.ajax({
                        url: '/Admin/AdminUsers/Save',
                        type: 'POST',
                        data: formData,
                        contentType: false, processData: false,
                        success: function (res) {
                            if (res.success) {
                                showToast(res.message, 'success');
                                setTimeout(function() { location.reload(); }, 1500);
                            } else {
                                showToast(res.message, 'error');
                            }
                        },
                        error: function () { showToast("Lỗi hệ thống!", 'error'); }
                    });
                }
            });

            // --- 8. XÓA ---
            $('body').on('click', '.btn-delete', function () {
                $('#deleteName').text($(this).data('id'));
                $('#deleteId').val($(this).data('id'));
                $('#deleteModal').modal('show');
            });

            $('#btnConfirmDelete').click(function () {
                $.ajax({
                    url: '/Admin/AdminUsers/Delete',
                    type: 'POST',
                    data: { id: $('#deleteId').val() },
                    success: function (res) {
                        if (res.success) {
                            $('#deleteModal').modal('hide');
                            showToast(res.message, 'success');
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            showToast(res.message, 'error');
                        }
                    },
                    error: function() { showToast("Không thể xóa khách hàng này.", 'error'); }
                });
            });
        });
    </script>
}