@using ScentoryApp.Models
@using System.Text.Json;

@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    var recentOrders = ViewData["RecentOrders"] as List<DonHang> ?? new List<DonHang>();
    var recentCustomers = ViewData["RecentCustomers"] as List<KhachHang> ?? new List<KhachHang>();
    var recentBlogs = ViewData["RecentBlogs"] as List<Blog> ?? new List<Blog>();

    // JSON strings for JavaScript using camelCase versions from controller
    var weeklySalesJson = JsonSerializer.Serialize(ViewData["WeeklySalesData"] ?? new List<object>());
    var productSummaryJson = JsonSerializer.Serialize(ViewData["ProductSummaryJson"] ?? new List<object>());
    var orderStatusJson = JsonSerializer.Serialize(ViewData["OrderStatusJson"] ?? new List<object>());
    var customerGenderJson = JsonSerializer.Serialize(ViewData["CustomerGenderJson"] ?? new List<object>());
    var blogCategoryJson = JsonSerializer.Serialize(ViewData["BlogCategoryJson"] ?? new List<object>());
    var totalCountsJson = JsonSerializer.Serialize(ViewData["TotalCounts"] ?? new List<object>());
    var totalCountsServer = ViewData["TotalCounts"] as IEnumerable<object> ?? new List<object>();
    Func<object, string, string> GetProp = (obj, prop) =>
    {
        if (obj == null) return string.Empty;
        var t = obj.GetType();
        try
        {
            var p = t.GetProperty(prop, System.Reflection.BindingFlags.IgnoreCase | System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance);
            if (p != null)
            {
                var v = p.GetValue(obj);
                return v?.ToString() ?? string.Empty;
            }
        }
        catch { }
        // try IDictionary
        try
        {
            var dict = obj as System.Collections.IDictionary;
            if (dict != null)
            {
                foreach (var key in dict.Keys)
                {
                    if (string.Equals(key?.ToString(), prop, StringComparison.OrdinalIgnoreCase))
                        return dict[key]?.ToString() ?? string.Empty;
                }
            }
        }
        catch { }
        return obj.ToString();
    };
    var productSummaryServer = ViewData["ProductSummary"] as List<ProductCategorySummary> ?? new List<ProductCategorySummary>();
    var orderStatusServer = ViewData["OrderStatusSummary"] as List<ChartSummaryItem> ?? new List<ChartSummaryItem>();
    var customerGenderServer = ViewData["CustomerGenderSummary"] as List<ChartSummaryItem> ?? new List<ChartSummaryItem>();
    var blogCategoryServer = ViewData["BlogCategorySummary"] as List<ChartSummaryItem> ?? new List<ChartSummaryItem>();
    // Server-side gender counts (Nam / Nữ / Không có thông tin)
    var genderCounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase) {
        { "Nam", 0 }, { "Nữ", 0 }, { "Không có thông tin", 0 }
    };
    foreach (var g in customerGenderServer)
    {
        var key = (g.Name ?? string.Empty).Trim();
        if (string.IsNullOrEmpty(key))
        {
            genderCounts["Không có thông tin"] += g.Count;
        }
        else
        {
            var lower = key.ToLowerInvariant();
            if (lower == "nam" || lower == "male" || lower == "m") genderCounts["Nam"] += g.Count;
            else if (lower == "nữ" || lower == "nu" || lower == "female" || lower == "f") genderCounts["Nữ"] += g.Count;
            else genderCounts["Không có thông tin"] += g.Count;
        }
    }
    // JSON fallbacks for client-side usage
    var productSummaryServerJson = JsonSerializer.Serialize(productSummaryServer.Select(p => new { categoryName = p.CategoryName, count = p.Count, percentage = p.Percentage }));
    var orderStatusServerJson = JsonSerializer.Serialize(orderStatusServer.Select(s => new { name = s.Name, count = s.Count }));
    var customerGenderServerJson = JsonSerializer.Serialize(customerGenderServer.Select(s => new { name = s.Name, count = s.Count }));
    var blogCategoryServerJson = JsonSerializer.Serialize(blogCategoryServer.Select(s => new { name = s.Name, count = s.Count }));
    var totalCountsServerJson = JsonSerializer.Serialize(totalCountsServer);
}

<div class="container-fluid">
    <!-- Quick total cards (server-rendered for immediate visibility) -->
    <div class="row mb-4">
        @foreach (var item in totalCountsServer)
        {
            var nameVal = GetProp(item, "name");
            var countVal = GetProp(item, "count");
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="text-muted small">@nameVal</div>
                                <div class="h4 mb-0">@countVal</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <!-- Weekly Sales & Total Counts -->
    <div class="row mb-5">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5 class="card-title">Doanh thu 7 ngày gần nhất</h5>
                    <canvas id="weeklySalesChart" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5 class="card-title">Thống kê tổng quan</h5>
                    <canvas id="totalCountsChart" height="180"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Categories -->
    <div class="row mb-5">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Thống kê sản phẩm theo danh mục <a class="float-right small text-muted" asp-area="Admin" asp-controller="AdminProducts" asp-action="Index">Xem tất cả</a></h5>
                    <div id="productSummaryContainer">
                        @if (productSummaryServer.Any())
                        {
                            @foreach (var p in productSummaryServer)
                            {
                                <div class="row align-items-center my-3">
                                    <div class="col">
                                        <strong>@p.CategoryName</strong>
                                        <div class="my-0 text-muted small">@p.Count sản phẩm</div>
                                    </div>
                                    <div class="col-auto"><strong>@String.Format("{0:0.0}%", p.Percentage)</strong></div>
                                    <div class="col-4">
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" role="progressbar" style="width: @String.Format("{0:0.0}", p.Percentage)%" aria-valuenow="@Math.Floor(p.Percentage)" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5 class="card-title">Phân bố sản phẩm</h5>
                    <canvas id="productDonutChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders -->
    <div class="row mb-5">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Đơn hàng gần đây <a class="float-right small text-muted" asp-area="Admin" asp-controller="AdminOrders" asp-action="Index">Xem tất cả</a></h5>
                    <table class="table table-borderless table-hover">
                        <thead><tr><th>ID</th><th>Khách hàng</th><th>Ngày đặt</th><th>Tổng</th><th>Trạng thái</th></tr></thead>
                        <tbody>
                            @foreach (var order in recentOrders)
                            {
                                <tr>
                                    <td>@order.IdDonHang</td>
                                    <td>@(order.IdKhachHangNavigation?.HoTen ?? "N/A")</td>
                                    <td>@order.ThoiGianDatHang.ToString("dd/MM/yyyy")</td>
                                    <td>@order.TongTienDonHang.ToString("C0")</td>
                                    <td>@order.TinhTrangDonHang</td>
                                </tr>
                            }
                            @if (!recentOrders.Any())
                            {
                                <tr><td colspan="5" class="text-center">Không có đơn hàng nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Trạng thái đơn hàng</h5>
                    <canvas id="orderStatusChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers -->
    <div class="row mb-5">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Khách hàng gần đây <a class="float-right small text-muted" asp-area="Admin" asp-controller="AdminUsers" asp-action="Index">Xem tất cả</a></h5>
                    <table class="table table-borderless table-hover">
                        <thead><tr><th>Tên</th><th>Email</th><th>SĐT</th></tr></thead>
                        <tbody>
                            @foreach (var customer in recentCustomers)
                            {
                                <tr><td>@customer.HoTen</td><td>@customer.Email</td><td>@customer.Sdt</td></tr>
                            }
                            @if (!recentCustomers.Any())
                            {
                                <tr><td colspan="3" class="text-center">Không có khách hàng nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Phân bố giới tính</h5>
                    <canvas id="customerGenderChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Blogs -->
    <div class="card shadow mb-5">
        <div class="card-body">
            <h5 class="card-title">Thống kê Blog theo danh mục</h5>
            <canvas id="blogCategoryChart" height="220"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Parse JSON data from view
        const weeklySalesData = @Html.Raw(weeklySalesJson);
        const productSummaryDataFromView = @Html.Raw(productSummaryJson);
        const orderStatusDataFromView = @Html.Raw(orderStatusJson);
        const customerGenderDataFromView = @Html.Raw(customerGenderJson);
        const blogCategoryDataFromView = @Html.Raw(blogCategoryJson);
        const totalCountsDataFromView = @Html.Raw(totalCountsJson);

        // Server-side fallbacks (serialized above) in case ViewData JSON is empty
        const productSummaryFallback = @Html.Raw(productSummaryServerJson);
        const orderStatusFallback = @Html.Raw(orderStatusServerJson);
        const customerGenderFallback = @Html.Raw(customerGenderServerJson);
        const blogCategoryFallback = @Html.Raw(blogCategoryServerJson);
        const totalCountsFallback = @Html.Raw(totalCountsServerJson);

        // Choose primary if non-empty, else fallback
        const productSummaryData = (productSummaryDataFromView && productSummaryDataFromView.length) ? productSummaryDataFromView : productSummaryFallback;
        const orderStatusData = (orderStatusDataFromView && orderStatusDataFromView.length) ? orderStatusDataFromView : orderStatusFallback;
        const customerGenderData = (customerGenderDataFromView && customerGenderDataFromView.length) ? customerGenderDataFromView : customerGenderFallback;
        const blogCategoryData = (blogCategoryDataFromView && blogCategoryDataFromView.length) ? blogCategoryDataFromView : blogCategoryFallback;
        const totalCountsData = (totalCountsDataFromView && totalCountsDataFromView.length) ? totalCountsDataFromView : totalCountsFallback;

        // Debug: Check data
        console.log('Product Summary Data:', productSummaryData);
        console.log('Weekly Sales Data:', weeklySalesData);
        console.log('Total Counts Data:', totalCountsData);

        // Use a global singleton for chart colors to avoid redeclaration errors
        window.chartColors = window.chartColors || ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1'];
        const chartColorsLocal = window.chartColors;

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Chart object available:', typeof Chart, Chart);
            // Render Product Summary from chart data
            if (productSummaryData && productSummaryData.length > 0) {
                const container = document.getElementById('productSummaryContainer');
                container.innerHTML = productSummaryData.map(p => `
                    <div class="row align-items-center my-3">
                        <div class="col">
                            <strong>${p.categoryName}</strong>
                            <div class="my-0 text-muted small">${p.count} sản phẩm</div>
                        </div>
                        <div class="col-auto"><strong>${p.percentage.toFixed(1)}%</strong></div>
                        <div class="col-4">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: ${p.percentage.toFixed(1)}%" aria-valuenow="${Math.floor(p.percentage)}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Weekly Sales Chart
            if (weeklySalesData && weeklySalesData.length > 0) {
                const ctx = document.getElementById("weeklySalesChart").getContext('2d');
                const dates = weeklySalesData.map(d => {
                    const dateStr = d.date || d.Date; // support both lower/upper case just in case
                    const [year, month, day] = dateStr.split('-');
                    return day + '/' + month + '/' + year;
                });
                const sales = weeklySalesData.map(d => d.total || d.Total);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Doanh thu (VND)',
                            data: sales,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#007bff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                callbacks: {
                                    label: function(context) {
                                        var value = null;
                                        try {
                                            if (context.parsed && typeof context.parsed === 'object') value = context.parsed.y || context.parsed;
                                            else if (context.parsed !== undefined) value = context.parsed;
                                        } catch (e) { value = context.yLabel || context.value || context; }
                                        if (value === null || value === undefined) value = (context.yLabel !== undefined ? context.yLabel : (context.raw || 0));
                                        if (typeof value === 'object' && value.y !== undefined) value = value.y;
                                        return 'Doanh thu: ' + Number(value).toLocaleString('vi-VN') + ' VND';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(val) {
                                        return val.toLocaleString('vi-VN');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Total Counts Chart
            if (totalCountsData && totalCountsData.length > 0) {
                const ctx = document.getElementById("totalCountsChart").getContext('2d');
                const labels = totalCountsData.map(item => item.name);
                const counts = totalCountsData.map(item => item.count);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                            datasets: [{
                            label: 'Tổng số',
                            data: counts,
                            backgroundColor: chartColorsLocal.slice(0, labels.length)
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Product Donut Chart
            if (productSummaryData && productSummaryData.length > 0) {
                const ctx = document.getElementById("productDonutChart").getContext('2d');
                const labels = productSummaryData.map(p => p.categoryName);
                const counts = productSummaryData.map(p => p.count);

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Order Status Chart
            if (orderStatusData && orderStatusData.length > 0) {
                const ctx = document.getElementById("orderStatusChart").getContext('2d');
                const labels = orderStatusData.map(s => s.name);
                const counts = orderStatusData.map(s => s.count);

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Customer Gender Chart - normalize into Nam / Nữ / Không có thông tin
            if (customerGenderData) {
                const ctx = document.getElementById("customerGenderChart").getContext('2d');
                // initialize buckets
                const genderBuckets = { 'Nam': 0, 'Nữ': 0, 'Không có thông tin': 0 };
                (customerGenderData || []).forEach(g => {
                    const raw = (g.name || '').toString().trim().toLowerCase();
                    if (!raw) {
                        genderBuckets['Không có thông tin'] += (g.count || 0);
                    } else if (raw === 'nam' || raw === 'male' || raw === 'm') {
                        genderBuckets['Nam'] += (g.count || 0);
                    } else if (raw === 'nữ' || raw === 'nu' || raw === 'female' || raw === 'f') {
                        genderBuckets['Nữ'] += (g.count || 0);
                    } else {
                        // any other string -> treat as unknown
                        genderBuckets['Không có thông tin'] += (g.count || 0);
                    }
                });

                const labels = ['Nam', 'Nữ', 'Không có thông tin'];
                const counts = labels.map(l => genderBuckets[l] || 0);

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#4A90E2', '#FF6B9D', '#6c757d']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Blog Category Chart - show specific categories in requested order
            if (blogCategoryData) {
                const ctx = document.getElementById("blogCategoryChart").getContext('2d');
                const desired = ['Thương hiệu','Sản phẩm','HDSD','Kiến thức','Mẹo','Storytelling'];
                // normalize incoming data to a lookup
                const lookup = {};
                (blogCategoryData || []).forEach(b => {
                    const key = (b.name || '').toString().trim();
                    if (key) lookup[key] = (lookup[key] || 0) + (b.count || 0);
                });
                const labels = desired;
                const counts = desired.map(d => lookup[d] || 0);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Số lượng bài viết',
                            data: counts,
                            backgroundColor: '#8dd3c7'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        });
    </script>
}
