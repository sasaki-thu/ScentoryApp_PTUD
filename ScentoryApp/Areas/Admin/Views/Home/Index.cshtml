@model ScentoryApp.Areas.Admin.Models.DashboardViewModel
@using System.Text.Json

@{
    ViewData["Title"] = "Tổng quan quản trị";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    // 1. TÍNH TOÁN NGÀY CHO NÚT ĐIỀU HƯỚNG TUẦN
    var currentStart = Model.StartDateSelected;
    var currentEnd = currentStart.AddDays(6);
    var prevWeekDate = currentStart.AddDays(-7).ToString("yyyy-MM-dd");
    var nextWeekDate = currentStart.AddDays(7).ToString("yyyy-MM-dd");
    bool isFuture = currentStart.AddDays(7) > DateTime.Today;

    // 2. CHUYỂN DỮ LIỆU C# SANG JSON ĐỂ VẼ BIỂU ĐỒ
    var chartLabels = JsonSerializer.Serialize(Model.LabelsBieuDo);
    var chartRevenue = JsonSerializer.Serialize(Model.DataBieuDoDoanhThu);
    var chartOrders = JsonSerializer.Serialize(Model.DataBieuDoDonHang);
    var pieLabels = JsonSerializer.Serialize(Model.TyLeTrangThaiDonHang?.Select(x => x.Label) ?? new List<string>());
    var pieData = JsonSerializer.Serialize(Model.TyLeTrangThaiDonHang?.Select(x => x.Value) ?? new List<int>());
}

<style>
    /* Custom CSS cho Dashboard */
    .card-dashboard {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }

        .card-dashboard:hover {
            transform: translateY(-5px);
        }

    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .bg-light-primary {
        background-color: rgba(78, 115, 223, 0.1);
        color: #4e73df;
    }

    .bg-light-success {
        background-color: rgba(28, 200, 138, 0.1);
        color: #1cc88a;
    }

    .bg-light-warning {
        background-color: rgba(246, 194, 62, 0.1);
        color: #f6c23e;
    }

    .bg-light-info {
        background-color: rgba(54, 185, 204, 0.1);
        color: #36b9cc;
    }

    .table-custom th {
        border-top: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #8898aa;
        font-weight: 700;
    }

    .table-custom td {
        vertical-align: middle;
    }

    .avatar-sm {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Style cho nút điều hướng tuần */
    .btn-nav-week {
        min-width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

        .btn-nav-week:hover:not(:disabled) {
            background-color: #e2e6ea;
        }
</style>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h2 page-title">Dashboard Admin</h2>
            <p class="text-muted mb-0">Xin chào, tổng quan tình hình kinh doanh hôm nay.</p>
        </div>
        <button class="btn btn-primary shadow-sm" onclick="location.reload()">
            <i class="fe fe-refresh-cw mr-2"></i> Cập nhật dữ liệu
        </button>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Doanh thu tháng này</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">@Model.DoanhThuThangNay.ToString("N0") ₫</div>
                        </div>
                        <div class="icon-circle bg-light-primary"><i class="fe fe-dollar-sign"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Doanh thu hôm nay</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">@Model.DoanhThuHomNay.ToString("N0") ₫</div>
                        </div>
                        <div class="icon-circle bg-light-success"><i class="fe fe-trending-up"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Đơn cần xử lý</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">@Model.DonHangMoi</div>
                        </div>
                        <div class="icon-circle bg-light-warning"><i class="fe fe-shopping-cart"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tổng khách hàng</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">@Model.TongKhachHang</div>
                        </div>
                        <div class="icon-circle bg-light-info"><i class="fe fe-users"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-xl-8 col-lg-7">
            <div class="card card-dashboard mb-4">

                <div class="card-header bg-transparent py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">DOANH THU THEO TUẦN</h6>

                    <div class="d-flex align-items-center bg-white border rounded px-2 py-1 shadow-sm">
                        <a href="@Url.Action("Index", "Home", new { area = "Admin", date = prevWeekDate })" class="btn btn-nav-week text-primary" title="Tuần trước">
                            <i class="fe fe-chevron-left"></i>
                        </a>

                        <span class="mx-3 font-weight-bold text-gray-800 small text-nowrap">
                            @currentStart.ToString("dd/MM") - @currentEnd.ToString("dd/MM/yyyy")
                        </span>

                        @if (isFuture)
                        {
                            <button class="btn btn-nav-week text-muted" disabled title="Chưa có dữ liệu">
                                <i class="fe fe-chevron-right"></i>
                            </button>
                        }
                        else
                        {
                            <a href="@Url.Action("Index", "Home", new { area = "Admin", date = nextWeekDate })" class="btn btn-nav-week text-primary" title="Tuần sau">
                                <i class="fe fe-chevron-right"></i>
                            </a>
                        }
                    </div>
                </div>

                <div class="card-body">
                    <div class="chart-area" style="height: 320px;">
                        <canvas id="myAreaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card card-dashboard mb-4">
                <div class="card-header bg-transparent py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Tỷ lệ trạng thái đơn</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="height: 345px;">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-lg-8 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-header bg-transparent py-3 border-0">
                    <h6 class="m-0 font-weight-bold text-primary">Đơn hàng vừa đặt</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-custom table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="pl-4">Mã đơn</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày đặt</th>
                                    <th>Tổng tiền</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DonHangGanDay != null && Model.DonHangGanDay.Any())
                                {
                                    foreach (var item in Model.DonHangGanDay)
                                    {
                                        <tr>
                                            <td class="pl-4 font-weight-bold">#@item.IdDonHang</td>
                                            <td>@(item.IdKhachHangNavigation?.HoTen ?? "Khách vãng lai")</td>

                                            <td>@item.ThoiGianDatHang.ToString("dd/MM/yyyy HH:mm")</td>

                                            <td>@item.TongTienDonHang.ToString("N0") ₫</td>
                                            <td>
                                                @if (item.TinhTrangDonHang == "Hoàn tất" || item.TinhTrangDonHang == "Đã giao")
                                                {
                                                    <span class="badge badge-pill badge-success px-2 py-1" style="background-color: #2ecc71;">@item.TinhTrangDonHang</span>
                                                }
                                                else if (item.TinhTrangDonHang == "Đang giao")
                                                {
                                                    <span class="badge badge-pill text-white px-2 py-1" style="background-color: #17a2b8;">@item.TinhTrangDonHang</span>
                                                }
                                                else if (item.TinhTrangDonHang == "Đã hủy")
                                                {
                                                    <span class="badge badge-pill badge-danger px-2 py-1" style="background-color: #dc3545">@item.TinhTrangDonHang</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-pill badge-warning text-white px-2 py-1" style="background-color: #f39c12">@item.TinhTrangDonHang</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="5" class="text-center py-3 text-muted">Chưa có đơn hàng nào</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card card-dashboard h-100">
                <div class="card-header bg-transparent py-3 border-0">
                    <h6 class="m-0 font-weight-bold text-primary">Sản phẩm bán chạy</h6>
                </div>
                <div class="card-body">
                    @if (Model.SanPhamBanChay != null && Model.SanPhamBanChay.Any())
                    {
                        foreach (var sp in Model.SanPhamBanChay)
                        {
                            <div class="d-flex align-items-center mb-4">
                                <div class="mr-3">
                                    @if (!string.IsNullOrEmpty(sp.HinhAnh))
                                    {
                                        <img src="data:image/jpeg;base64,@sp.HinhAnh" class="avatar-sm shadow-sm" alt="img">
                                    }
                                    else
                                    {
                                        <div class="avatar-sm bg-light d-flex align-items-center justify-content-center text-muted rounded"><i class="fe fe-image"></i></div>
                                    }
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h6 class="mb-1 text-truncate" title="@sp.TenSanPham">@sp.TenSanPham</h6>
                                    <small class="text-muted">Đã bán: <strong>@sp.SoLuongBan</strong></small>
                                </div>
                                <div class="text-right">
                                    <span class="text-success font-weight-bold small">@sp.TongTien.ToString("#,##0")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Chưa có dữ liệu sản phẩm</p>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        Chart.defaults.font.family = 'Nunito, -apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
        Chart.defaults.color = '#858796';

        document.addEventListener("DOMContentLoaded", function() {

            // --- 1. BIỂU ĐỒ CỘT + ĐƯỜNG (DOANH THU TUẦN) ---
            var ctx = document.getElementById("myAreaChart");
            if(ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: @Html.Raw(chartLabels), // Nhãn: T2, T3, T4...
                        datasets: [{
                            label: "Doanh thu",
                            type: 'line',
                            lineTension: 0.3,
                            backgroundColor: "rgba(78, 115, 223, 0.05)",
                            borderColor: "rgba(78, 115, 223, 1)",
                            pointRadius: 3,
                            pointBackgroundColor: "rgba(78, 115, 223, 1)",
                            pointBorderColor: "rgba(78, 115, 223, 1)",
                            pointHoverRadius: 3,
                            pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                            pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                            pointHitRadius: 10,
                            pointBorderWidth: 2,
                            data: @Html.Raw(chartRevenue), 
                            yAxisID: 'y',
                        },
                        {
                            label: "Số đơn hàng",
                            type: 'bar',
                            backgroundColor: "rgba(28, 200, 138, 0.5)",
                            data: @Html.Raw(chartOrders), 
                            yAxisID: 'y1',
                            barThickness: 20
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        layout: { padding: { left: 10, right: 25, top: 25, bottom: 0 } },
                        scales: {
                            x: { grid: { display: false, drawBorder: false } },
                            y: {
                                type: 'linear', display: true, position: 'left',
                                ticks: {
                                    maxTicksLimit: 5, padding: 10,
                                    callback: function(value) { return value.toLocaleString('vi-VN') + 'đ'; }
                                },
                                grid: { color: "rgb(234, 236, 244)", zeroLineColor: "rgb(234, 236, 244)", drawBorder: false, borderDash: [2], zeroLineBorderDash: [2] }
                            },
                            y1: {
                                type: 'linear', display: true, position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { beginAtZero: true, precision: 0 }
                            }
                        },
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                mode: 'index', intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        var label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.dataset.type === 'line') {
                                            label += context.parsed.y.toLocaleString('vi-VN') + 'đ';
                                        } else {
                                            label += context.parsed.y + ' đơn';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- 2. BIỂU ĐỒ TRÒN (PIE CHART) ---
            var ctxPie = document.getElementById("myPieChart");
            if (ctxPie) {
                var myLabels = @Html.Raw(pieLabels);
                var myBgColors = [];
                var myHoverColors = [];

                myLabels.forEach(function(label) {
                    var l = label.toLowerCase();

                    if (l.includes("đã giao") || l.includes("hoàn tất")) {
                        myBgColors.push("#2ecc71");
                        myHoverColors.push("#27ae60");
                    }
                    else if (l.includes("đang giao")) {
                        myBgColors.push("#17a2b8");
                        myHoverColors.push("#138496");
                    }
                    else if (l.includes("đã hủy")) {
                        myBgColors.push("#dc3545");
                        myHoverColors.push("#c82333");
                    }
                    else {
                        myBgColors.push("#f39c12");
                        myHoverColors.push("#d68910");
                    }
                });

                // 3. Vẽ biểu đồ
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: myLabels,
                        datasets: [{
                            data: @Html.Raw(pieData),
                            backgroundColor: myBgColors,
                            hoverBackgroundColor: myHoverColors,
                            hoverBorderColor: "rgba(234, 236, 244, 1)",
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.label || '';
                                        var value = context.parsed || 0;
                                        return ' ' + label + ': ' + value + ' đơn';
                                    }
                                }
                            }
                        },
                        cutout: '70%',
                    },
                });
            }
        });
    </script>
}