@model ScentoryApp.Models.ShopFilterViewModel

@{
    ViewData["Title"] = "Cửa Hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="page-header py-5" style="background-color: #FFF7F1;">
    <div class="container text-center">
        <h1 class="section-title text-uppercase">Cửa Hàng</h1>
        <p class="text-secondary w-100 mx-auto">
            Khám phá bộ sưu tập mùi hương tinh tế của Scentory !
        </p>
    </div>
</section>

<div class="container py-5">
    <div class="row">
        <!-- ==================== SIDEBAR BÊN TRÁI ==================== -->
        <div class="col-lg-3 col-md-4">
            <div class="shop-sidebar">

                <!-- 1. LỌC THEO GIÁ (Thanh trượt) -->
                <div class="filter-group">
                    <h5 class="filter-title">Khoảng giá</h5>
                    <input type="range"
                           class="form-range"
                           min="@Model.ActualMinPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                           max="@Model.ActualMaxPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                           step="10000"
                           id="priceRange"
                           value="@Model.ActualMaxPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)">
                    <div class="d-flex justify-content-between mt-2">
                        <span class="small text-muted">@Model.ActualMinPrice.ToString("N0")đ</span>
                        <span class="small text-muted" id="currentMaxPrice">@Model.ActualMaxPrice.ToString("N0")đ</span>
                    </div>
                </div>

                <hr />

                <!-- 2. LỌC THEO DANH MỤC -->
                <div class="filter-group">
                    <h5 class="filter-title">Danh mục sản phẩm</h5>
                    @if (Model.Categories != null && Model.Categories.Any())
                    {
                        <ul class="category-list">
                            @foreach (var category in Model.Categories)
                            {
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input category-checkbox"
                                               type="checkbox"
                                               id="cat_@category.IdDanhMuc"
                                               value="@category.IdDanhMuc">
                                        <label class="form-check-label" for="cat_@category.IdDanhMuc">
                                            @category.TenDanhMuc
                                            <span class="category-count">(@category.ProductCount)</span>
                                        </label>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small">Không có danh mục</p>
                    }
                </div>

                <hr />

            </div>
        </div>

        <!-- ==================== NỘI DUNG SẢN PHẨM BÊN PHẢI ==================== -->
        <div class="col-lg-9 col-md-8">

            <!-- THANH SẮP XẾP & HIỂN THỊ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <span id="resultCount">Hiển thị @Model.TotalItems sản phẩm</span>
                <select class="form-select w-auto" id="sortSelect">
                    <option value="default">Sắp xếp mặc định</option>
                    <option value="price_asc">Giá: Thấp đến cao</option>
                    <option value="price_desc">Giá: Cao đến thấp</option>
                    <option value="newest">Mới nhất</option>
                </select>
            </div>

            <!-- LƯỚI SẢN PHẨM -->
            <div class="row" id="productGrid">
                @if (Model.Products != null && Model.Products.Any())
                {
                    foreach (var item in Model.Products)
                    {
                        <div class="col-lg-3 col-md-6 col-6 mb-5">
                            <div class="product-card">
                                <a href="@Url.Action("ProductDetails", "Home", new { id = item.IdSanPham })" class="product-link">
                                    <div class="product-img-wrap">
                                        @{
                                            string imgSrc;
                                            if (item.AnhSanPham != null && item.AnhSanPham.Length > 0)
                                            {
                                                var base64 = Convert.ToBase64String(item.AnhSanPham);
                                                imgSrc = $"data:image/jpeg;base64,{base64}";
                                            }
                                            else
                                            {
                                                imgSrc = Url.Content("~/assets/images/placeholder-product.png");
                                            }
                                        }
                                        <img src="@imgSrc"
                                             alt="@item.TenSanPham"
                                             class="img-fluid mb-3">
                                    </div>
                                </a>

                                <div class="price-wrap">
                                    @{
                                        var salePrice = item.GiaNiemYet;
                                        var originalPrice = salePrice * 1.1m;
                                    }
                                    <span class="sale-price">@salePrice.ToString("N0") ₫</span>
                                    <span class="original-price">@originalPrice.ToString("N0") ₫</span>
                                </div>

                                <div class="product-info">
                                    <p class="product-title">
                                        @item.TenSanPham
                                    </p>

                                    <button class="btn btn-add-cart"
                                            data-id="@item.IdSanPham">
                                        <i class="fa fa-shopping-cart"></i> Thêm vào giỏ hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fa fa-info-circle"></i> Không có sản phẩm nào.
                        </div>
                    </div>
                }
            </div>

            <!-- PHÂN TRANG -->
            <nav aria-label="Page navigation" class="mt-4" id="paginationContainer">
                @if (Model.TotalPages > 1)
                {
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="#" data-page="@(Model.CurrentPage - 1)">←</a>
                        </li>

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="#" data-page="@i">@i</a>
                            </li>
                        }

                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="#" data-page="@(Model.CurrentPage + 1)">→</a>
                        </li>
                    </ul>
                }
            </nav>

        </div>
    </div>
</div>

<!-- ==================== STYLES ==================== -->
<style>
    /* ========== PRODUCT CARD STYLES ========== */
    .product-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .product-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .product-title {
        min-height: 3em;
        margin-bottom: 10px;
        font-weight: normal;
        font-size: 1em;
        color: #000;
        text-align: center;
    }

    .price-wrap {
        margin-bottom: auto;
        padding-bottom: 10px;
        text-align: center;
    }

    .sale-price {
        color: #dc3545;
        font-weight: bold;
        font-size: 1.1em;
        margin-right: 8px;
    }

    .original-price {
        text-decoration: line-through;
        color: #999;
        font-size: 0.9em;
    }

    .btn-add-cart {
        background-color: #c3a374;
        color: white;
        border: none;
        padding: 10px 15px;
        width: 100%;
        text-align: center;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        margin-top: auto;
    }

        .btn-add-cart:hover {
            background-color: #a66b42;
            color: white;
        }

        .btn-add-cart i {
            margin-right: 5px;
        }

    /* ========== FILTER SIDEBAR STYLES ========== */
    .shop-sidebar {
        position: sticky;
        top: 100px;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .filter-group {
        margin-bottom: 20px;
    }

    /* ========== CATEGORY LIST STYLES ========== */
    .category-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

        .category-list li {
            margin-bottom: 8px;
        }

        .category-list .form-check {
            padding-left: 0;
            display: flex;
            align-items: center;
        }

        .category-list .form-check-input {
            margin-left: 0;
            margin-right: 8px;
            cursor: pointer;
        }

        .category-list .form-check-label {
            cursor: pointer;
            margin: 0;
            display: flex;
            align-items: center;
            width: 100%;
        }

    .category-count {
        color: #999;
        font-size: 0.9em;
        margin-left: 5px;
    }


    /* ========== SLIDER STYLES ========== */

    .form-range. {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        width: 100% !important;
        height: 6px !important;
        background: #ddd !important;
        border-radius: 3px !important;
        outline: none !important;
        padding: 0 !important;
        margin: 10px 0 !important;
        cursor: pointer !important;
    }

        /* ========== THUMB STYLES ========== */

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            appearance: none !important;
            width: 22px !important;
            height: 22px !important;
            background: #C38154 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            cursor: grab !important;
            border: 3px solid #fff !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
            margin-top: -8px !important; 
            transition: all 0.2s ease !important;
            position: relative !important;
            z-index: 10 !important;
        }


        /* ========== HOVER ========== */

        .form-range::-webkit-slider-thumb:hover {
            background: #a66b42 !important;
            transform: scale(1.15) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
            cursor: grabbing !important;
        }

        .form-range::-moz-range-thumb:hover {
            background: #a66b42 !important;
            transform: scale(1.15) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
            cursor: grabbing !important;
        }

        .form-range::-ms-thumb:hover {
            background: #a66b42 !important;
            transform: scale(1.15) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
        }

        /* ========== ACTIVE ========== */

        .form-range:active::-webkit-slider-thumb {
            background: #8b5a35 !important;
            transform: scale(1.2) !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
            cursor: grabbing !important;
        }

        .form-range:active::-moz-range-thumb {
            background: #8b5a35 !important;
            transform: scale(1.2) !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
            cursor: grabbing !important;
        }

        .form-range:active::-ms-thumb {
            background: #8b5a35 !important;
            transform: scale(1.2) !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
        }

        .form-range:focus {
            outline: none !important;
            box-shadow: none !important;
        }

            .form-range:focus::-webkit-slider-thumb {
                box-shadow: 0 0 0 4px rgba(195, 129, 84, 0.3) !important;
            }

            .form-range:focus::-moz-range-thumb {
                box-shadow: 0 0 0 4px rgba(195, 129, 84, 0.3) !important;
            }


    .filter-group {
        position: relative !important;
    }

        .filter-group input[type="range"] {
            pointer-events: auto !important;
            touch-action: none !important; 
        }

    .form-range::-webkit-slider-runnable-track {
        background: #ddd !important;
    }

    .form-range::-moz-range-progress {
        background-color: #C38154 !important;
        height: 6px !important;
        border-radius: 3px !important; */
    }


    .filter-group .form-check-input:checked {
        background-color: #c38154;
        border-color: #c38154;
    }

    .filter-group .form-check-input:focus {
        border-color: #c38154;
        box-shadow: 0 0 0 0.25rem rgba(195, 129, 84, 0.25);
    }

    /* ========== PAGINATION STYLES ========== */
    .pagination {
        gap: 10px;
    }

        .pagination .page-item {
            margin: 0;
        }

        .pagination .page-link {
            color: #C38154;
            background-color: #fff;
            border: 2px solid #C38154;
            padding: 9px 16px;
            font-weight: 500;
            border-radius: 0;
            transition: all 0.3s ease;
            min-width: 50px;
            text-align: center;
            cursor: pointer;
        }

            .pagination .page-link:hover {
                color: #fff;
                background-color: #C38154;
                border-color: #C38154;
            }

        .pagination .page-item.active .page-link {
            background-color: #C38154;
            border-color: #C38154;
            color: #fff;
            font-weight: bold;
        }

        .pagination .page-item.disabled .page-link {
            color: #999;
            background-color: #f5f5f5;
            border-color: #ddd;
            cursor: not-allowed;
        } 

    /* ========== SORT SELECT STYLES ========== */
    .form-select:focus {
        border-color: #C38154;
        box-shadow: 0 0 0 0.25rem rgba(195, 129, 84, 0.25);
    }

    /* ========== LOADING STATE ========== */
    #productGrid.loading {
        opacity: 0.5;
        pointer-events: none;
    }
    
</style>

<!-- ==================== SCRIPTS ==================== -->
<script src="~/js/toast.js"></script>
<script src="~/js/shop-filter.js"></script>

<script>
    document.querySelectorAll(".btn-add-cart").forEach(btn => {
        btn.addEventListener("click", function () {
            const productId = this.dataset.id;

            fetch("/Cart/AddToCart", {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `id=${productId}&quantity=1`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (typeof loadMiniCart === 'function') {
                        loadMiniCart();
                    }
                    showToast("Thêm vào giỏ hàng thành công", "success");
                } else {
                    showToast("Không thể thêm vào giỏ hàng", "error");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast("Có lỗi xảy ra", "error");
            });
        });
    });
</script>
