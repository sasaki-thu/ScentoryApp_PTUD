@model ScentoryApp.Models.KhachHang
@{
    ViewData["Title"] = "Tài khoản của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Color Palette */
    :root {
        --cream: #E7DECF;
        --biscotti: #DAC09B;
        --latte: #D0BCA1;
        --toffee: #9F815B;
        --cocoa: #81614A;
    }

    /* Page Body & Content */
    .account-page-area {
    }

        /* Navigation Pills */
        .account-page-area .nav-pills .nav-link {
            padding: 15px 20px;
            border: 1px solid var(--biscotti);
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--cocoa);
            background-color: var(--cream);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

            .account-page-area .nav-pills .nav-link.active,
            .account-page-area .nav-pills .nav-link:hover {
                background-color: var(--toffee);
                color: #fff;
                border-color: var(--toffee);
            }

            .account-page-area .nav-pills .nav-link i {
                font-size: 24px;
            }

    /* Card Styles */
    .account-card {
        border-radius: 5px;
        border: 1px solid var(--biscotti);
        background-color: #fff;
    }

        .account-card .card-header {
            background-color: var(--latte);
            padding: 15px 20px;
            border-bottom: 1px solid var(--biscotti);
            font-weight: 700;
            font-size: 18px;
            color: var(--cocoa);
        }

        .account-card .card-body {
            padding: 25px;
        }

    /* Form & Button Styles */
    .form-label {
        color: var(--cocoa);
        font-weight: 500;
    }

    .btn-custom-brown {
        background-color: var(--toffee);
        border-color: var(--toffee);
        color: #fff;
        padding: 10px 25px;
        font-weight: 600;
        border-radius: 5px;
        transition: all 0.3s ease;
    }

        .btn-custom-brown:hover {
            background-color: var(--cocoa);
            border-color: var(--cocoa);
            color: #fff;
        }

    .btn-custom-brown-sm {
        background-color: var(--toffee);
        border-color: var(--toffee);
        color: #fff;
        padding: 5px 10px;
        font-weight: 600;
        font-size: 14px;
        border-radius: 3px;
        transition: all 0.3s ease;
    }

        .btn-custom-brown-sm:hover {
            background-color: var(--cocoa);
            border-color: var(--cocoa);
            color: #fff;
        }

    .table {
        --bs-table-border-color: var(--biscotti);
        --bs-table-color: var(--cocoa);
    }

        .table thead th {
            color: var(--cocoa);
            font-weight: 600;
        }


    .border-top-dashed {
        border-top: 1px dashed var(--biscotti);
        padding-top: 0.75rem;
    }

    /* TIÊU ĐỀ TRONG MODAL CHI TIẾT ĐƠN HÀNG */
    .order-section-title {
        font-size: 20px; 
        font-weight: 700;
        color: var(--cocoa); 
        margin-bottom: 8px;
        text-transform: uppercase;
    }


</style>

<!-- Begin Main Content Area -->
<main class="main-content">
    <div class="breadcrumb-area breadcrumb-height" style="background-image: url('../assets/images/breadcrumb/bg/1-1-1920x373.jpg');">
        <div class="container h-100">
            <div class="row h-100">
                <div class="col-lg-12">
                    <div class="breadcrumb-item">
                        <h2 class="breadcrumb-heading">@ViewData["Title"]</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="account-page-area section-space-y-axis-100">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <ul class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="v-pills-account-info-tab" data-bs-toggle="pill" href="#v-pills-account-info" role="tab" aria-controls="v-pills-account-info" aria-selected="true">
                                <i class="pe-7s-user"></i>
                                Thông tin tài khoản
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="v-pills-orders-tab" data-bs-toggle="pill" href="#v-pills-orders" role="tab" aria-controls="v-pills-orders" aria-selected="false">
                                <i class="pe-7s-box2"></i>
                                Đơn hàng của tôi
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content" id="v-pills-tabContent">
                        <div class="tab-pane fade show active" id="v-pills-account-info" role="tabpanel" aria-labelledby="v-pills-account-info-tab">
                            <div class="account-card">
                                <div class="card-header">
                                    THÔNG TIN TÀI KHOẢN
                                </div>
                                <div class="card-body">
                                    @if(TempData["AccountInfoMessage"] != null) {
                                        <div class="alert alert-success">@TempData["AccountInfoMessage"]</div>
                                    }
                                    <form asp-action="AccountUpdate"
                                          asp-controller="Home"
                                          method="post">
                                        @Html.AntiForgeryToken()
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Tên đăng nhập*</label>
                                                <input type="text" class="form-control" value="@(Model?.IdTaiKhoanNavigation?.TenDangNhap ?? "")" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Họ và tên*</label>
                                                <input type="text" name="FullName" class="form-control" value="@(Model?.HoTen ?? "")">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Email*</label>
                                                <input type="email" name="Email" class="form-control" value="@(Model?.Email ?? "")">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Số điện thoại*</label>
                                                <input type="text" name="Phone" class="form-control" value="@(Model?.Sdt ?? "")">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Địa chỉ*</label>
                                            <input type="text" name="Address" class="form-control" value="@(Model?.DiaChi ?? "")">
                                        </div>
                                        <button type="submit" class="btn btn-custom-brown">
                                            LƯU THAY ĐỔI
                                        </button>
                                    </form>

                                    <hr />
                                    @if (TempData["PasswordMessage"] != null)
                                    {
                                        <div class="alert alert-info">
                                            @TempData["PasswordMessage"]
                                        </div>
                                    }
                                    <form asp-action="ChangePassword"
                                          asp-controller="Home"
                                          method="post">
                                        @Html.AntiForgeryToken()
                                        <fieldset class="mb-4">
                                            <legend class="h6">Đổi mật khẩu</legend>
                                            <div class="mb-3">
                                                <label class="form-label">Mật khẩu hiện tại</label>
                                                <input type="password" name="CurrentPassword" class="form-control">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Mật khẩu mới</label>
                                                <input type="password" name="NewPassword" class="form-control">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Xác nhận mật khẩu mới</label>
                                                <input type="password" name="ConfirmNewPassword" class="form-control">
                                            </div>
                                            <button type="submit"
                                                    class="btn btn-custom-brown">
                                                ĐỔI MẬT KHẨU
                                            </button>
                                        </fieldset>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="v-pills-orders" role="tabpanel" aria-labelledby="v-pills-orders-tab">
                            <div class="account-card">
                                <div class="card-header">
                                    LỊCH SỬ ĐẶT HÀNG
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Mã ĐH</th>
                                                    <th>Ngày đặt</th>
                                                    <th>Trạng thái</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Hành động</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orders-table-body">
                                                <!-- Order rows will be inserted here by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Main Content Area End Here -->
<!-- Begin Order Detail Modal -->

<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--latte); border-bottom: 1px solid var(--biscotti); padding: 0.8rem 1rem;">
                <h5 class="modal-title" id="orderDetailModalLabel" style="color: var(--cocoa); font-weight: 700;"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: var(--cream); padding: 0.8rem 1rem;">
                <!-- Modal content will be injected here by JavaScript -->
            </div>
            <div class="modal-footer" style="background-color: var(--latte); border-top: 1px solid var(--biscotti); padding: 0.5rem 1rem;">
                <button type="button" class="btn btn-custom-brown btn-sm" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- End Order Detail Modal -->
@section Scripts {
    <script>
        $(document).ready(function () {

            const tableBody = $('#orders-table-body');

            // LOAD ĐƠN HÀNG
            $.get('/Home/GetMyOrders', function (orders) {
                tableBody.empty();

                orders.forEach(order => {
                    const row = `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${new Date(order.date).toLocaleDateString('vi-VN')}</td>
                            <td>${order.status}</td>
                            <td>${order.total.toLocaleString('vi-VN')}₫</td>
                            <td>
                                <button class="btn btn-custom-brown-sm view-order-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailModal"
                                        data-order-id="${order.id}">
                                    Xem
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.append(row);
                });
            });

        // LOAD CHI TIẾT ĐƠN
        $('#orderDetailModal').on('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const orderId = button.getAttribute('data-order-id');

            $.get('/Home/GetOrderDetail', { orderId: orderId }, function (order) {

                const modal = $('#orderDetailModal');
                modal.find('.modal-title').text(`Chi tiết đơn hàng #${order.id}`);

                let html = `
                    <h6 class="order-section-title">SẢN PHẨM ĐÃ ĐẶT</h6>

                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-end">Giá</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                order.products.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.name}</td>
                            <td class="text-center">${p.quantity}</td>
                            <td class="text-end">${p.price.toLocaleString('vi-VN')}₫</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td colspan="2">Tổng tiền sản phẩm</td>
                                <td class="text-end">
                                    ${order.tongTienSanPham.toLocaleString('vi-VN')}₫
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <hr />

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="order-section-title">CHI TIẾT THANH TOÁN</h6>

                            <div class="d-flex justify-content-between">
                                <span>Tổng tiền sản phẩm:</span>
                                <span>${order.tongTienSanPham.toLocaleString('vi-VN')}₫</span>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span>Phí vận chuyển:</span>
                                <span>${order.shippingFee.toLocaleString('vi-VN')}₫</span>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span> Giảm giá ${order.discountCode ? `(${order.discountCode})`: ''}:</span>
                                <span>- ${order.discountAmount.toLocaleString('vi-VN')}₫</span>
                            </div>
                            <hr />

                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Tổng tiền đơn hàng:</span>
                                <span>${order.total.toLocaleString('vi-VN')}₫</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="order-section-title">THÔNG TIN GIAO HÀNG</h6>

                            <div>
                                <strong>Địa chỉ:</strong><br />
                                ${order.shippingInfo.address}
                            </div>

                            <div class="mt-2">
                                <strong>SĐT:</strong><br />
                                ${order.shippingInfo.phone}
                            </div>
                        </div>
                    </div>
                `;

                modal.find('.modal-body').html(html);
            });
        });


        });
    </script>
}

