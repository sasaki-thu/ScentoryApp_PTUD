@{
    ViewData["Title"] = "Giỏ hàng";
}

<div class="container my-5">
    <h2 class="mb-4 fw-bold">Giỏ hàng của bạn</h2>

    <table class="table cart-table align-middle">
        <thead>
            <tr>
                <th><input type="checkbox" id="check-all" /></th>
                <th>Sản phẩm</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Tạm tính</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
    </table>

    <div class="text-end mt-4">
        <button id="buy-btn" disabled class="btn btn-primary px-5">
            MUA HÀNG
        </button>
    </div>
</div>

<script>
    function formatVN(n) {
        return n.toLocaleString("vi-VN") + " đ";
    }

    function updateBuyButton() {
        document.getElementById("buy-btn").disabled =
            document.querySelectorAll(".cart-item-checkbox:checked").length === 0;
    }

    function syncCheckAll() {
        const all = document.querySelectorAll(".cart-item-checkbox");
        const checked = document.querySelectorAll(".cart-item-checkbox:checked");
        document.getElementById("check-all").checked =
            all.length > 0 && all.length === checked.length;
    }

    document.getElementById("check-all").onchange = e => {
        document.querySelectorAll(".cart-item-checkbox")
            .forEach(cb => cb.checked = e.target.checked);
        updateBuyButton();
    };

    document.addEventListener("change", e => {
        if (e.target.classList.contains("cart-item-checkbox")) {
            syncCheckAll();
            updateBuyButton();
        }
    });

    function loadCart() {
        fetch("/Cart/GetCartItems")
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById("cart-body");
                tbody.innerHTML = "";

                if (!d.items || d.items.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">Giỏ hàng trống</td>
                        </tr>`;
                    return;
                }

                d.items.forEach(i => {
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <input type="checkbox"
                                       class="cart-item-checkbox"
                                       data-id="${i.id}">
                            </td>
                            <td>
                                <img src="${i.img}" style="width:60px;height:60px;border-radius:6px">
                                ${i.name}
                            </td>
                            <td>${formatVN(i.price)}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-secondary minus" data-id="${i.id}">−</button>
                                    <span>${i.quantity}</span>
                                    <button class="btn btn-sm btn-outline-secondary plus" data-id="${i.id}">+</button>
                                </div>
                            </td>
                            <td>${formatVN(i.subtotal)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger remove" data-id="${i.id}">✕</button>
                            </td>
                        </tr>`;
                });

                bindActions();
            });
    }

    function bindActions() {
        document.querySelectorAll(".plus").forEach(b =>
            b.onclick = () => updateQty(b.dataset.id, 1)
        );
        document.querySelectorAll(".minus").forEach(b =>
            b.onclick = () => updateQty(b.dataset.id, -1)
        );
        document.querySelectorAll(".remove").forEach(b =>
            b.onclick = () => removeItem(b.dataset.id)
        );
    }

    function updateQty(id, delta) {
        fetch("/Cart/UpdateQuantity", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `productId=${id}&delta=${delta}`
        }).then(loadCart);
    }

    function removeItem(id) {
        fetch("/Cart/RemoveItem", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `productId=${id}`
        }).then(loadCart);
    }

    document.getElementById("buy-btn").onclick = () => {
        const ids = [...document.querySelectorAll(".cart-item-checkbox:checked")]
            .map(cb => cb.dataset.id);

        fetch("/Checkout/Prepare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(ids)
        }).then(() => window.location.href = "/Checkout");
    };

    document.addEventListener("DOMContentLoaded", loadCart);
</script>
